

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jhierz Trading toggleJournals</title>
  <style>

    
    :root{
      --bg:#030910; --card:#0c0725; --text:#eee3e3; --green:#79ebb4; --red:#f05129d8;
      --border:#e9f7eb80; --blue:#386885; --accent:#b8e3ff; --muted:#94a3b8;
       --today-glow: hsla(68, 100%, 51%, 0.915);
    }
    *{box-sizing:border-box}


    body{
      margin:0; font-family:Segoe UI,system-ui,-apple-system,Arial,sans-serif;
      background:#261d50; color:var(--text); display:flex; flex-direction:column; height:100vh;
      background-image:url('ice.jpg'); background-size:cover; background-position:center; background-repeat:no-repeat; background-attachment:fixed;
    }



 body::before {
  content:"";
  position:fixed;
  inset:0;
  background:rgba(117, 135, 179, 0.5); /* lighter overlay so image shows more */
  z-index:-1;
}

#bgVideo {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -2; /* ensures it's behind */
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5); /* optional dark overlay */
  z-index: -1; /* sits above video, below journal */
}


   header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap; /* allows wrapping on narrow screens */
  padding: 1rem;
  background: #061123;
  color: var(--accent);
  text-shadow: 0 0 5px var(--accent);
  gap: 1rem;
}

header > div {
  flex: 1 1 auto;
}

header > div:first-child { text-align: left; }
header > div:last-child { text-align: right; }
header .center-title {
  flex: 1 1 40%;
  text-align: center;
  font-weight: 700;
  font-size: 1.6rem;
}

    header .center-title{flex:1; text-align:center; font-weight:700; font-size:1.6rem}
   
    .yellow-text{color:#12da3a}

    .container{display:flex; flex:1; min-height:0}
    
   
    
    .main{flex:1; padding:1rem; overflow:auto}

    label{display:block; margin:.5rem 0 .25rem; color:var(--muted); font-size:.9rem}
    input,select,button{width:100%; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:.55rem .6rem}
    button{cursor:pointer; background:#094a2e; transition:background .25s}
    button:hover{background:#2a5f7b}
    .row{display:flex; gap:.5rem}

    /* Journals header (collapsible) */
    .collapser{display:flex; align-items:center; justify-content:space-between; background:#0d2233; border:1px solid var(--border); padding:.55rem .7rem; border-radius:8px; margin-bottom:.5rem}
    .collapser b{letter-spacing:.3px}
    #journalList{display:grid; gap:.4rem; margin-bottom:.6rem}
    #journalList button{background:#0f2435}
    #journalList button.active{outline:2px solid #52ffa8; background:#103443}

    .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
.modal-content {
  display: flex;
  flex-direction: column;
  max-height: 80vh;   /* prevent it from going off-screen */
}

.journal-list {
  flex: 1;
  overflow-y: auto;   /* scrollable */
  max-height: 40vh;   /* adjust how much space list can take */
  margin: .5rem 0;
  border: 1px solid var(--text);
  padding: .5rem;
  border-radius: .5rem;
}

.journal-actions, .modal-actions {
  margin-top: .5rem;
  flex-shrink: 0;     /* keep buttons from being pushed off */
}

  .day-header {
  text-align:center;
  font-weight:600;
  color: var(--accent);
  padding: 4px 0;
  border-bottom: 1px solid var(--border);
}
  
   .day {
  position:relative;
  min-height:78px;
  padding:6px 6px 8px;
  border-radius:10px;
  border:2px solid var(--border);
  background:rgba(16,20,32,0.8); /* more transparent */
  box-shadow:inset 0 0 4px rgba(140,190,240,.35);

  font-size:.8rem;
}
@keyframes glow {
  0% {
    box-shadow: 0 0 8px var(--today-glow), 0 0 16px var(--today-glow), 0 0 24px var(--today-glow);
  }
  100% {
    box-shadow: 0 0 12px var(--today-glow), 0 0 24px var(--today-glow), 0 0 36px var(--today-glow);
  }
}

    
    .day:hover{outline:2px solid rgba(184,227,255,.25)}
    .day.positive{background:linear-gradient(180deg, rgba(16,50,32,.9), rgba(7,29,19,.95)); border-color:rgba(0,255,128,.35)}
    .day.negative{background:linear-gradient(180deg, rgba(60,18,18,.8), rgba(25,6,6,.95)); border-color:#812e2e}
    .day strong{position:absolute; top:6px; right:8px; font-size:.72rem; color:#aab}
   .today-ring { position:absolute; inset:-2px; border-radius:10px; border:2px solid var(--today-glow); box-shadow:0 0 8px var(--today-glow), 0 0 16px var(--today-glow), 0 0 24px var(--today-glow); pointer-events:none; animation: glow 1.5s infinite alternate; }

    .entry-symbol{font-weight:700; font-size:.9rem; display:inline-flex; align-items:center; gap:6px}
    .entry-pnl{font-weight:700; margin-top:2px}
    .entry-link{color:var(--blue); text-decoration:underline}
    .pct{font-size:.78rem; margin-top:2px}
    .positive{color:var(--green)}
    .negative{color:var(--red)}

    .week-summary,.overview{margin-top:1rem; background:var(--card); padding:1rem; border-radius:10px; border:1px solid var(--border)}
    .week-summary .line{display:flex; justify-content:space-between; padding:.25rem 0; font-size:.95rem; border-bottom:1px dashed #1f3b46}
    .week-summary .line:last-child{border-bottom:none}

    /* compact weekly summary single-line chips */
    .compact-weekly{display:flex; flex-wrap:wrap; gap:6px}
    .compact-weekly .chip{padding:.35rem .6rem; border-radius:6px; background:linear-gradient(180deg,#06131a,#041018); border:1px solid rgba(255,255,255,0.03); font-size:.9rem}
    .chip.positive{color:var(--green)}
    .chip.negative{color:var(--red)}

    .modal{display:none; position:fixed; inset:0; z-index:50; background:rgba(0,0,0,.6); align-items:center; justify-content:center}
    .modal-content{width:360px; max-width:95%; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:1rem}
    .modal-actions{display:flex; gap:.5rem}
    .small-inputs{display:flex; gap:.5rem}
    .small-inputs input{width:50%;}
 

    
    @media (max-width: 900px){
      .container{flex-direction:column}
      .sidebar{width:100%; border-right:none; border-bottom:1px solid var(--border)}
      header{flex-direction:column; gap:.5rem; text-align:center}
    }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  background: #0c0725;
  color: #eee3e3;
}

.layout {
  display: flex;
  height: 100vh;
}


 
 .sidebar {
  width: 280px;
  background: rgba(12, 7, 37, 0.5); /* slightly transparent */
  padding: 1rem;
  border-right: 1px solid var(--border);
  overflow: auto;
  backdrop-filter: blur(6px); /* optional: adds a frosted glass effect */
}

/* Right panel */
.sidebar-right {
  width: 280px;
  background: rgba(12, 7, 37, 0.5); /* slightly transparent */
  padding: 1rem;
  border-right: 1px solid var(--border);
  overflow: auto;
  backdrop-filter: blur(6px); /* optional: adds a frosted glass effect */
}



/* Sidebar collapse styles */
.sidebar {
  transition: transform 0.3s ease;
}

.sidebar.collapsed {
  transform: translateX(-100%);
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  z-index: 999;
  background: var(--card);
}

.sidebar-toggle {
  background: transparent;
  border: none;
  font-size: 1.3rem;     /* neat size */
  line-height: 1;        /* removes extra vertical spacing */
  color: var(--accent);
  cursor: pointer;
  padding: 4px 6px;      /* small padding */
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;           /* fixed width */
  height: 36px;          /* fixed height */
  transition: background 0.2s;
}

.sidebar-toggle:hover {
  background: rgba(255,255,255,0.08); /* subtle hover */
}


@media (max-width: 768px) {
  .sidebar {
    position: absolute;
    width: 250px;
    height: 100%;
    left: 0;
    top: 0;
    transform: translateX(-100%);
  }
}

.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.35rem 0.5rem;
  border-bottom: 1px dashed rgba(255,255,255,0.1);
  font-size: 0.9rem;
}

.history-item button {
  background: var(--green);
  border: none;
  color: #e8b7b7;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
}

.history-item button:hover {
  background: #12a432;
}
@media (max-width: 1100px) {
  #historyModal .modal-content {
    width: 95%;
    height: 80%;
  }
}
.history-item {
  display: grid;
  grid-template-columns: 2fr 1fr auto; /* Date | Amount | Delete */
  align-items: center;
  padding: 0.5rem 0.7rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size:0.95rem;
}

.history-item span {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.history-item button {
  background: var(--green);
  border: none;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size:0.85rem;
}

.history-item button:hover {
  background: #3309b4;
}

    
  </style>
</head>
<body>


  

<!-- Video background -->
<video autoplay muted loop playsinline id="bgVideo">
  <source src="goku.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>



  


  <header>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="row" style="margin-top:0.5rem;">
      <button id="sidebarToggle" class="sidebar-toggle">☰</button>



      
<button id="toggleGraphBtn" style="padding:0.35rem 0.6rem; font-size:0.85rem; width:auto; margin-bottom:10px;">
  📈PnL Graph
</button>

<div id="chartContainer" style="width:100%; height:400px; margin-top:10px; display:none;">
  <canvas id="pnlChart"></canvas>
</div>
<div id="pnlGraphOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  z-index:100;
  align-items:center;
  justify-content:center;
  flex-direction:column;
">
  <button onclick="togglePnLGraph()" style="
    position:absolute;
    top:21px;
    right:2px;
    padding:0.5rem 1rem;
    font-size:1rem;
    z-index:101;
  ">❌ Close</button>
  <canvas id="pnlGraph" style="max-width:95%; max-height:90%;"></canvas>
</div>




    <div>💰 Start: $<span id="headerStartingBalance" class="yellow-text">0.00</span></div>
    <div class="center-title">Jhierz Trading Journal</div>
    <div>📅 Monthly: <span id="headerMonthlyPnl" class="yellow-text">$0.00</span>
      (<span id="headerMonthlyGainPercent" class="yellow-text">0.00%</span>)
      &nbsp;&nbsp; 📊 Balance: $<span id="headerCurrentBalance" class="yellow-text">0.00</span>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">

<!-- NEW Journals Button -->
<button id="openJournalsPopup"><b>📔Manage Journals</b></button>
<!-- Journals Popup -->
<div class="modal" id="journalsModal">
  <div class="modal-content">
    <h3 style="margin-top:0">📔 Manage Journals</h3>
   <div id="journalList" class="journal-list"></div>


    <div class="row" style="margin-top:.8rem;">
      <input id="newJournalName" placeholder="New Journal Name" />
    </div>
    <div class="row" style="margin-top:.5rem;">
      <button onclick="addJournal()">Add</button>
      <button onclick="deleteJournal()">Delete</button>
      <button onclick="renameJournal()">Rename</button>
    </div>

    <div class="modal-actions" style="margin-top:1rem;">
      <button onclick="closeJournalsPopup()">Close</button>
    </div>
  </div>
</div>



      <label>Year</label>
      <select id="yearSelect" onchange="renderCalendar()"></select>
      <label>Month</label>
      <select id="monthSelect" onchange="renderCalendar()">
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>

      <label>Starting Balance</label>
      <input id="startBalance" type="number" step="0.01" onchange="updateStartBalance()" />

      <div class="overview" id="overviewStats"></div>

     
    </aside>

     

    <main class="main">
      <div class="calendar"
       id="calendar"></div>
      <div class="week-summary"
       id="weeklySummary">
        <!-- compact weekly chips will be injected here -->
        <div id="compactWeekly" class="compact-weekly"></div>
      </div>
    </main>


  <!-- Modal -->
  <div class="modal" id="entryModal">
    <div class="modal-content">
      <h3 style="margin-top:0">Day Entry</h3>
      <input id="entrySymbol" placeholder="Symbol" />
      <input id="entryPnl" type="number" step="0.01" placeholder="PnL" />
      <div class="small-inputs">
        <input id="entryWins" type="number" min="0" placeholder="Winning Trades" />
        <input id="entryLosses" type="number" min="0" placeholder="Losing Trades" />
      </div>
      <input id="entryLink" placeholder="Link (optional)" />
      <div class="modal-actions">
        <button onclick="saveEntry()">Save</button>
        <button onclick="closeModal()">Cancel</button>
        <button onclick="deleteEntry()">Delete</button>
      </div>
    </div>
  </div>
  <div class="sidebar-right">
    <div>
  <span style="font-size: 40px;">💳</span> <span style="color: rgb(235, 235, 4);">Withdrawal</span>
</div>

    <div class="row in line">

      <input type="withdrawtxt"placeholder="    Amount">
      <button id="historybtn">History</button>
  </div> 
</div> 

<!-- Withdrawal History Modal -->
<div class="modal" id="historyModal">
  <div class="modal-content" style="width:100%; max-width:1000px; height:600px; max-height:90%; display:flex; flex-direction:column; padding:1rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
      <h3 style="margin:0; font-size:1.2rem; font-weight:700; color:var(--accent);">💰 Withdrawal History</h3>
     <button onclick="closeHistoryModal()" style="
  background: var(--green);
  color: #fff;
  border: none;
  width: 36px;
  height: 36px;
  font-size: 1rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
">❌</button>

    </div>
    <div id="historyList" style="flex:1; overflow-y:auto; border-top:1px solid var(--border); padding-top:0.5rem; font-family:Segoe UI, sans-serif; font-size:0.9rem;"></div>
  </div>
</div>

<script>
const calendar = document.getElementById('calendar');
const yearSelect = document.getElementById('yearSelect');
const monthSelect = document.getElementById('monthSelect');
const journalList = document.getElementById('journalList');
const startBalanceInput = document.getElementById('startBalance');
const overviewStats = document.getElementById('overviewStats');
const weeklySummary = document.getElementById('weeklySummary');
const compactWeekly = document.getElementById('compactWeekly');

let data = JSON.parse(localStorage.getItem('tradingData')) || {};
let currentJournal = Object.keys(data)[0] || 'Main';
let selectedDate = null;
let withdrawals = JSON.parse(localStorage.getItem('withdrawals')) || [];

// ------------------ CHART ------------------
let pnlChart = null;
document.getElementById('toggleGraphBtn').onclick = togglePnLGraph;

function togglePnLGraph() {
  const overlay = document.getElementById('pnlGraphOverlay');
  overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
  if (overlay.style.display === 'flex') drawPnLChart();
}

function drawPnLChart() {
  const ctx = document.getElementById('pnlGraph').getContext('2d');
  const entries = data[currentJournal].entries || {};
  const labels = Object.keys(entries).sort();
  const pnlValues = labels.map(d => parseFloat(entries[d].pnl || 0));

  if (pnlChart) pnlChart.destroy();

  pnlChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Daily PnL',
        data: pnlValues,
        fill: true,
        tension: 0.3,
        pointRadius: 4,
        pointHoverRadius: 6,
        borderWidth: 2,
        borderColor: 'lime',
        backgroundColor: 'rgba(0,255,0,0.15)',
        segment: {
          borderColor: ctx => (ctx.p0.parsed.y >= 0 && ctx.p1.parsed.y >= 0) ? 'lime' : 'red',
          backgroundColor: ctx => (ctx.p0.parsed.y >= 0 && ctx.p1.parsed.y >= 0) ? 'rgba(0,255,0,0.15)' : 'rgba(255,0,0,0.15)'
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#eee' } } },
      scales: {
        x: { ticks: { color: '#eee' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { ticks: { color: '#eee' }, grid: { color: ctx => ctx.tick.value === 0 ? 'white' : 'rgba(255,255,255,0.1)' }, beginAtZero: true }
      }
    }
  });
}

// ------------------ DATA ------------------
function saveData(){ localStorage.setItem('tradingData', JSON.stringify(data)); }

function migrateJournalEntries(){
  if(!data || typeof data !== 'object') data = {};
  Object.keys(data).forEach(journal => {
    if(!data[journal]) return;
    if(!data[journal].entries){
      const possibleEntries = {};
      Object.keys(data[journal]).forEach(k => {
        if(k==='start'||k==='entries') return;
        if(/\d{4}-\d{2}-\d{2}/.test(k) || /\d{1,2}-\d{1,2}/.test(k)){
          possibleEntries[k]=data[journal][k];
          delete data[journal][k];
        }
      });
      data[journal].entries = possibleEntries;
    }
    if(typeof data[journal].start === 'undefined') data[journal].start = 0;
    Object.entries(data[journal].entries || {}).forEach(([dateKey,e])=>{
      if(!e) return;
      if(('wins' in e) || ('losses' in e)) return;
      if('trades' in e){ const t=parseInt(e.trades)||0; e.wins=t; e.losses=0; delete e.trades;}
      else { e.wins=e.wins||0; e.losses=e.losses||0;}
    });
  });
  saveData();
}

// ------------------ JOURNALS ------------------
function updateJournalList(){
  journalList.innerHTML='';
  if(!data[currentJournal]) data[currentJournal]={entries:{},adjustments:{},start:0};
  Object.keys(data).forEach(journal=>{
    const btn=document.createElement('button');
    btn.textContent=journal;
    btn.className=(journal===currentJournal)?'active':'';
    btn.onclick=()=>{
      currentJournal=journal;
      startBalanceInput.value=data[currentJournal].start||0;
      renderCalendar();
      updateJournalList();
    };
    journalList.appendChild(btn);
  });
}

function addJournal(){
  const name=document.getElementById('newJournalName').value.trim();
  if(name && !data[name]){
    data[name]={entries:{},adjustments:{},start:0};
    currentJournal=name;
    saveData(); updateJournalList(); renderCalendar();
  }
}

function deleteJournal(){
  if(!confirm(`Delete journal '${currentJournal}'?`)) return;
  delete data[currentJournal];
  const keys=Object.keys(data);
  currentJournal=keys[0]||'Main';
  if(!data[currentJournal]) data[currentJournal]={entries:{},start:0};
  saveData(); updateJournalList(); renderCalendar();
}

function renameJournal(){
  const newName=prompt("Enter new name for journal:",currentJournal);
  if(!newName) return;
  if(data[newName] && newName!==currentJournal){ alert("A journal with that name already exists!"); return; }
  data[newName]=data[currentJournal];
  if(newName!==currentJournal) delete data[currentJournal];
  currentJournal=newName;
  saveData(); updateJournalList(); renderCalendar();
}

function updateStartBalance(){
  const val=parseFloat(startBalanceInput.value);
  data[currentJournal].start=isNaN(val)?0:val;
  saveData(); renderCalendar();
}

// ------------------ JOURNALS POPUP ------------------
const journalsModal = document.getElementById('journalsModal');
const openJournalsBtn = document.getElementById('openJournalsPopup');

openJournalsBtn.onclick = () => {
  journalsModal.style.display = 'flex';
};

function closeJournalsPopup() {
  journalsModal.style.display = 'none';
}

// Close modal if clicked outside
window.addEventListener('click', e => {
  if (e.target === journalsModal) closeJournalsPopup();
});

// ------------------ MODAL ENTRY ------------------
function openModal(){ document.getElementById('entryModal').style.display='flex'; }
function closeModal(){ document.getElementById('entryModal').style.display='none'; }

function saveEntry(){
  const symbol=document.getElementById('entrySymbol').value.trim();
  const pnl=parseFloat(document.getElementById('entryPnl').value||0);
  const wins=parseInt(document.getElementById('entryWins').value)||0;
  const losses=parseInt(document.getElementById('entryLosses').value)||0;
  const link=document.getElementById('entryLink').value.trim();
  if(!selectedDate) return;
  if(!data[currentJournal].entries) data[currentJournal].entries={};
  data[currentJournal].entries[selectedDate]={symbol,pnl,wins,losses,link};
  saveData(); closeModal(); renderCalendar();
}

function deleteEntry(){
  if(!selectedDate) return;
  const entries=data[currentJournal].entries||{};
  if(entries[selectedDate]){ delete entries[selectedDate]; saveData(); }
  closeModal(); renderCalendar();
}

window.addEventListener('click', e=>{ if(e.target.id==='entryModal') closeModal(); });

// ------------------ RENDER CALENDAR ------------------
function renderCalendar(year = parseInt(yearSelect.value), month = parseInt(monthSelect.value)) {
  calendar.innerHTML = "";
  const firstDay = new Date(year, month, 1).getDay(); // 0 = Sun
  const daysInMonth = new Date(year, month+1, 0).getDate();

  // Weekday headers
  const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  weekdays.forEach(day => {
    const hd = document.createElement('div');
    hd.className = 'day-header';
    hd.textContent = day;
    calendar.appendChild(hd);
  });

  // Leading empty cells
  for(let i=0;i<firstDay;i++){
    const empty = document.createElement('div');
    empty.className='day empty';
    calendar.appendChild(empty);
  }

  const entries = data[currentJournal].entries || {};
  const today = new Date();

  for(let d=1; d<=daysInMonth; d++){
    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const entry = entries[dateKey] || {};
    const adj = parseFloat(data[currentJournal].adjustments?.[dateKey] || 0);
    const pnl = parseFloat(entry.pnl || 0);

    const cell = document.createElement('div');
    cell.className = 'day';
    if(pnl>0) cell.classList.add('positive');
    else if(pnl<0) cell.classList.add('negative');

    // Highlight today
    if(year===today.getFullYear() && month===today.getMonth() && d===today.getDate()){
      const ring = document.createElement('div');
      ring.className='today-ring';
      cell.appendChild(ring);
    }

    // Day number
    const strong = document.createElement('strong');
    strong.textContent = d;
    cell.appendChild(strong);

    // Symbol
    if(entry.symbol){
      const sym = document.createElement('div');
      sym.className='entry-symbol';
      sym.textContent = entry.symbol;
      if(entry.link && entry.link.startsWith('http')){
        const a = document.createElement('a');
        a.className='entry-link';
        a.href = entry.link;
        a.target='_blank';
        a.textContent=' 🔗';
        sym.appendChild(a);
      }
      cell.appendChild(sym);
    }

    // PnL
    if(!isNaN(pnl) && pnl!==0){
      const pnlDiv = document.createElement('div');
      pnlDiv.className='entry-pnl';
      pnlDiv.textContent=`$${pnl.toFixed(2)}`;
      pnlDiv.style.color = pnl>=0?'lime':'red';
      cell.appendChild(pnlDiv);
    }

    // Adjustments
    if(!isNaN(adj) && adj!==0){
      const adjDiv = document.createElement('div');
      adjDiv.className='adj';
      adjDiv.textContent = adj<0 ? `Withdraw: $${Math.abs(adj).toFixed(2)}` : `Deposit: $${adj.toFixed(2)}`;
      cell.appendChild(adjDiv);
    }

    cell.onclick = () => {
      selectedDate = dateKey;
      document.getElementById('entrySymbol').value = entry.symbol || '';
      document.getElementById('entryPnl').value = entry.pnl ?? '';
      document.getElementById('entryWins').value = entry.wins ?? 0;
      document.getElementById('entryLosses').value = entry.losses ?? 0;
      document.getElementById('entryLink').value = entry.link || '';
      openModal();
    };

    calendar.appendChild(cell);
  }

  renderOverview();
  renderWeeklySummary();
  updateHeaderBalances();
}

// ------------------ OVERVIEW ------------------
function renderOverview(){
  const entries = Object.entries(data[currentJournal].entries || {});
  let balance = parseFloat(data[currentJournal].start || 0);
  let wins=0, loss=0, totalTrades=0, best=-Infinity, worst=Infinity;

  entries.forEach(([dateKey, e])=>{
    const pnl = parseFloat(e.pnl || 0);
    const adj = parseFloat(data[currentJournal].adjustments?.[dateKey] || 0);
    balance += pnl + adj;
    if(pnl>0) wins++;
    if(pnl<0) loss++;
    totalTrades += (e.wins || 0) + (e.losses || 0);
    best = Math.max(best, pnl);
    worst = Math.min(worst, pnl);
  });

  const winRate = (wins+loss)>0 ? ((wins/(wins+loss))*100).toFixed(2)+'%' : '0%';
  overviewStats.innerHTML = `
    <div>📊 <b>Balance:</b> <span class="${balance>=0?'positive':'negative'}">$${balance.toFixed(2)}</span></div>
    <div>📈 <b>Total Trades:</b> ${totalTrades}</div>
    <div>✅ <b>Winning Trades:</b> <span class="positive">${wins}</span></div>
    <div>❌ <b>Losing Trades:</b> <span class="negative">${loss}</span></div>
    <div>🏁 <b>Win Rate:</b> ${winRate}</div>
    <div>🏆 <b>Best Day:</b> <span class="${best>=0?'positive':'negative'}">${best===-Infinity?'-':best}</span></div>
    <div>💔 <b>Worst Day:</b> <span class="${worst<0?'negative':'positive'}">${worst===Infinity?'-':worst}</span></div>
  `;
}

// ------------------ WEEKLY SUMMARY ------------------
function renderWeeklySummary(){
  compactWeekly.innerHTML='';
  const entries=data[currentJournal].entries||{};
  const year=parseInt(yearSelect.value);
  const month=parseInt(monthSelect.value);
  const startBal=parseFloat(data[currentJournal].start||0);
  let weekPnL=0; let weekNo=1;
  const daysInMonth=new Date(year,month+1,0).getDate();

  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d);
    const dow=date.getDay();
    const key=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const e=entries[key];
    const pnl=parseFloat(e?.pnl||0);
    if(!isNaN(pnl)) weekPnL+=pnl;

    const isWeekEnd=(dow===0 && d!==1);
    const isMonthEnd=(d===daysInMonth);

    if(isWeekEnd || isMonthEnd){
      const pct=startBal?((weekPnL/startBal)*100).toFixed(2):'0.00';
      const chip=document.createElement('div');
      chip.className=`chip ${weekPnL>=0?'positive':'negative'}`;
      chip.textContent=`W${weekNo}: $${weekPnL.toFixed(2)} (${pct}%)`;
      compactWeekly.appendChild(chip);
      weekPnL=0; weekNo++;
    }
  }
}

// ------------------ HEADER BALANCES ------------------
function updateHeaderBalances() {
  const entries = data[currentJournal].entries || {};
  const startBal = parseFloat(data[currentJournal].start || 0);
  const year = parseInt(yearSelect.value);
  const month = parseInt(monthSelect.value);

  let monthlyPnl = 0;
  let cumulativeBalance = startBal;

  Object.keys(entries).forEach(dateKey => {
    const entry = entries[dateKey];
    const adj = parseFloat(data[currentJournal].adjustments?.[dateKey] || 0);
    const pnl = parseFloat(entry.pnl || 0);
    cumulativeBalance += pnl + adj;

    if (dateKey.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)) {
      monthlyPnl += pnl + adj;
    }
  });

  // Include withdrawals in balance
  const monthlyWithdrawals = withdrawals
    .filter(w => {
      const d = new Date(w.date);
      return d.getFullYear() === year && d.getMonth() === month;
    })
    .reduce((sum,w)=>sum+w.amount,0);

  cumulativeBalance -= monthlyWithdrawals;
  monthlyPnl -= monthlyWithdrawals;

  const gainPercent = startBal ? ((monthlyPnl/startBal)*100).toFixed(2) : '0.00';

  document.getElementById('headerStartingBalance').textContent = startBal.toFixed(2);
  document.getElementById('headerCurrentBalance').textContent = cumulativeBalance.toFixed(2);
  document.getElementById('headerMonthlyPnl').textContent = `$${monthlyPnl.toFixed(2)}`;
  document.getElementById('headerMonthlyGainPercent').textContent = `${gainPercent}%`;

  const gainColor = monthlyPnl>0?'lightgreen': monthlyPnl<0?'salmon':'#e7e3e3';
  document.getElementById('headerMonthlyPnl').style.color = gainColor;
  document.getElementById('headerMonthlyGainPercent').style.color = gainColor;
}

// ------------------ WITHDRAWALS ------------------
const withdrawInput=document.querySelector('input[placeholder="    Amount"]');
const historyBtn=document.getElementById('historybtn');

historyBtn.onclick=()=>{
  renderHistory();
  document.getElementById('historyModal').style.display='flex';
};

function closeHistoryModal(){ document.getElementById('historyModal').style.display='none'; }

withdrawInput.addEventListener('keypress',e=>{
  if(e.key==='Enter' && withdrawInput.value.trim()!==''){
    addWithdrawal(parseFloat(withdrawInput.value));
    withdrawInput.value='';
  }
});

function addWithdrawal(amount){
  if(isNaN(amount) || amount <= 0) return;
  const date = new Date();
  withdrawals.push({ date: date.toLocaleDateString(), amount });
  localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
  renderHistory();
  renderCalendar();
  updateHeaderBalances();
}

function renderHistory(){
  const container=document.getElementById('historyList');
  container.innerHTML='';
  withdrawals.forEach((w,i)=>{
    const div=document.createElement('div');
    div.className='history-item';
    div.innerHTML=`<span>${w.date}</span><span>$${w.amount.toFixed(2)}</span><button onclick="deleteWithdrawal(${i})">❌</button>`;
    container.appendChild(div);
  });
}

function deleteWithdrawal(index){
  withdrawals.splice(index,1);
  localStorage.setItem('withdrawals',JSON.stringify(withdrawals));
  renderHistory();
  renderCalendar();
  updateHeaderBalances();
}

window.addEventListener('click',e=>{
  if(e.target.id==='historyModal') closeHistoryModal();
});

// ------------------ INIT ------------------
function init(){
  const now=new Date();
  const year=now.getFullYear();
  for(let y=year-5;y<=year+5;y++){
    const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSelect.appendChild(opt);
  }
  yearSelect.value=year; monthSelect.value=now.getMonth();
  if(Object.keys(data).length===0) data['Main']={entries:{},start:0};
  if(!data[currentJournal]) data[currentJournal]={entries:{},start:0};
  updateJournalList(); renderCalendar();
}
init();
</script>



</body>
</html>










